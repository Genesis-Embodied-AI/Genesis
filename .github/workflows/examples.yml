name: Examples (CPU)

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  run-examples:
    runs-on: ubuntu-22.04
    env:
      CI_EXAMPLES: "1"
      HF_HUB_DOWNLOAD_TIMEOUT: 60
      GS_CACHE_FILE_PATH: ".cache/genesis"
      TI_OFFLINE_CACHE: "1"
      TI_OFFLINE_CACHE_CLEANING_POLICY: "never"
      TI_OFFLINE_CACHE_FILE_PATH: ".cache/taichi"
      TI_ENABLE_CUDA: "0"
      TI_ENABLE_METAL: "0"
      TI_ENABLE_OPENGL: "0"
      TI_ENABLE_VULKAN: "0"
      TI_DEBUG: "0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Restore cache
        uses: actions/cache/restore@v4
        with:
          path: .cache
          key: examples-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            examples-${{ runner.os }}-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system deps (headless OpenGL)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1 \
            libegl1 \
            libglvnd-dev \
            libglew-dev \
            libegl-dev \
            libx11-6 \
            libxrender1 \
            libglib2.0-0 \
            libosmesa6-dev \
            libglx-mesa0 \
            libglu1-mesa \
            libegl1-mesa-dev \
            libgles2-mesa-dev

      - name: Install Python deps
        run: |
          pip install --upgrade pip setuptools wheel
          pip install -e '.[dev]'

      - name: Run examples suite
        run: |
          pytest -v -m required -k "examples_ci" --logical --forked

      - name: Save cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .cache
          key: examples-${{ runner.os }}-${{ github.run_id }}-${{ github.run_attempt }}


